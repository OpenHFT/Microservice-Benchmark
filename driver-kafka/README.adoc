= Kafka Benchmark

https://docs.confluent.io/cloud/current/client-apps/optimizing/latency.html

== Results

All tests were on the same single host, a Ryzen 9 59050X using fast NVMe storage.

Co-ordinated omission was accounted for. The time the message should have been sent is used, not the time it was actually sent. Delays in publishing could result in a recorded delay in sending the next message, when the delay is greater than the interval. For example, if we are sending a message every 10 microseconds, and publish takes 5 microseconds, no delay to the following message occurs, however if there is a delay of 1000 microseconds, then at least the next 100 messages show delays

=== High throughput configuration

In this case, the `kafka.yaml` file was used. The key settings were:

  - linger.ms=1
  - partitions=4
  - consumers=8

.100Kmsg/s
```
-------------------------------- SUMMARY (end to end) ------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:         1931.26      1902.59      1927.17      1914.88      1902.59         0.99
90.0:         2437.12      2396.16      2412.54      2404.35      2396.16         1.13
99.0:       293076.99      2633.73      2641.92      2641.92      2633.73        98.66
99.7:       609222.66      2789.38      2805.76      2797.57      2797.57        99.31
99.9:       718274.56      3313.66      3321.86      3420.16      3428.35        99.31
99.97:      816840.70      5447.68      5644.29      5824.51      5808.13        99.00
99.99:      848297.98      6299.65      6545.41      6807.55      6594.56        98.89
99.997:     860880.90      6791.17      7315.46      8298.50      7086.08        98.82
99.999:     865075.20      7053.31      9453.57      9945.09      7348.22        98.78
worst:      867172.35      8052.74     10534.91     10928.13      8470.53        98.61
-------------------------------- SUMMARY (publish) ---------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:            2.54         2.55         2.56         2.56         2.55         0.63
90.0:            2.80         2.78         2.80         2.80         2.79         0.57
99.0:           27.36        26.08        26.34        27.04        26.72         3.17
99.7:           39.74        34.24        34.50        35.14        34.88         9.68
99.9:          580.61        54.08        55.87        62.27        57.02        86.65
99.97:        3805.18       438.78       486.91       521.73       482.82        83.65
99.99:        6463.49       644.10       687.10       728.06       676.86        85.76
99.997:      10108.93       740.35      1027.07      1632.26       879.62        89.40
99.999:      12599.30       945.15      1648.64      3264.51      1029.12        89.15
worst:       14073.86      1730.56      2895.87      4579.33      1452.03        85.28
-------------------------------- SUMMARY (toService) -------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:          967.68       961.54       963.58       967.68       963.58         0.42
90.0:         1263.62      1251.33      1255.42      1255.42      1251.33         0.65
99.0:       290979.84      1329.15      1333.25      1333.25      1329.15        99.32
99.7:       607125.50      1423.36      1431.55      1439.74      1439.74        99.65
99.9:       716177.41      1857.54      1886.21      1947.65      1939.46        99.61
99.97:      816840.70      3616.77      3805.18      4116.48      3870.72        99.34
99.99:      846200.83      4677.63      4972.54      5234.69      4956.16        99.17
99.997:     858783.74      5169.15      5824.51      6660.10      5447.68        99.10
99.999:     862978.05      5464.06      7954.43      8101.89      5709.82        99.05
worst:      865075.20      5857.28      9027.58      9355.26      5988.35        98.99
```

.250Kmsg/s
```
-------------------------------- SUMMARY (end to end) ----------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:         3485.70      2879.49      3313.66      3731.46      4382.72        25.82
90.0:       125698.05     15319.04     23494.66     61145.09    152305.66        85.64
99.0:       335020.03     58130.43    104726.53    285736.96    494403.58        83.34
99.7:       358088.70     87687.17    115736.58    320339.97    524812.29        76.87
99.9:       375914.50    107610.11    122814.46    326631.42    529006.59        72.30
99.97:      379060.22    114688.00    130678.78    328728.58    532152.32        70.82
99.99:      380108.80    115998.72    131465.22    330825.73    532152.32        70.52
99.997:     381157.38    117833.73    132251.65    331874.30    533200.90        70.15
99.999:     381157.38    118620.16    132513.79    331874.30    533200.90        69.97
99.9997:    381157.38    119406.59    133038.08    331874.30    534249.47        69.84
worst:      382205.95    119930.88    133300.22    332922.88    534249.47        69.73
-------------------------------- SUMMARY (publish) --------------------------------------
50.0:            2.56         2.56         2.57         2.56         2.56         0.21
90.0:           46.78        38.59        40.38        40.26        42.05        12.40
99.0:          742.40       330.24       290.30       501.25       744.45        51.05
99.7:         1574.91      1595.39      1239.04      1705.98      8929.28        80.54
99.9:         2240.51     12468.22      3239.94      3280.90     22315.01        85.66
99.97:        3076.10     25001.98      6561.79      7823.36     28147.71        84.46
99.99:        3706.88     30965.76      8347.65     10240.00     31621.12        83.39
99.997:       4190.21     33456.13      9289.73     11026.43     34275.33        82.72
99.999:       4579.33     34144.26      9945.09     11321.34     35061.76        81.61
99.9997:      4775.94     34406.40     10141.70     11485.18     35192.83        80.94
worst:        4825.09     34406.40     10207.23     11550.72     35323.90        80.82
-------------------------------- SUMMARY (toService) ------------------------------------
50.0:         2232.32      1542.14      2037.76      2469.89      3117.06        40.51
90.0:       124387.33     14041.09     22249.47     59965.44    151257.09        86.69
99.0:       333971.46     56950.78    103415.81    284688.38    492306.43        83.60
99.7:       357040.13     86638.59    114425.86    319291.39    522715.14        77.04
99.9:       373817.34    106299.39    121503.74    325582.85    527958.02        72.56
99.97:      378011.65    113377.28    129368.06    327680.00    530055.17        71.02
99.99:      379060.22    114688.00    129892.35    329777.15    531103.74        70.77
99.997:     380108.80    116523.01    130678.78    330825.73    531103.74        70.34
99.999:     380108.80    116785.15    130940.93    330825.73    532152.32        70.34
99.9997:    380108.80    117047.30    131203.07    330825.73    532152.32        70.28
worst:      380108.80    117047.30    131203.07    330825.73    532152.32        70.28
```

=== Low latency configuration

In this case, the `kafka-latency.yaml` file was used. The key settings were:

- linger.ms=0
- partitions=1
- consumers=1

This configuration wasn't used for the throughputs above as the connection would drop out. In particular, the `linger.ms=0` quickly results in a dropped connection, so the warmup was made as short as possible to avoid a dropout in warmup.


.10kmsg/s
```
-------------------------------- SUMMARY (end to end) ------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:          214.78       212.22       210.18       211.20       212.74         1.44
90.0:          254.21       252.16       249.60       250.62       253.70         1.22
99.0:          387.58       380.42       389.63       377.34       376.32         2.30
99.7:         1153.02      1091.58      1018.88      1018.88       965.63        11.46
99.9:         2543.62      2453.50      2379.78      2371.58      2338.82         5.52
99.97:        3067.90      2871.30      2797.57      2805.76      2781.18         6.43
99.99:        4284.42      3362.82      3076.10      2969.60      2985.98        22.79
worst:        5332.99      5251.07      4497.41      4448.26      4333.57        13.33
-------------------------------- SUMMARY (publish) ---------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:            4.00         3.96         3.74         3.82         4.12         6.34
90.0:            4.42         6.06         4.10         6.04         5.85        24.07
99.0:            6.09         6.44         6.12         6.50         6.38         4.36
99.7:            6.30         6.70         6.30         6.78         6.62         4.84
99.9:            6.58         7.75         6.52         7.54         7.06        11.19
99.97:           7.61         8.50         7.54         8.40         8.14         7.76
99.99:           8.98         9.52         8.56         9.42         8.88         6.96
worst:         850.94      1041.41       930.82       850.94       799.74        16.77
-------------------------------- SUMMARY (toService) -------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:          106.88       106.37       105.34       105.60       105.86         0.96
90.0:          130.94       134.91       133.89       132.86       130.69         2.11
99.0:          222.98       227.07       232.19       222.98       215.81         4.82
99.7:          881.66       799.74       719.87       748.54       693.25        15.34
99.9:         2273.28      2183.17      2117.63      2117.63      2091.01         5.49
99.97:        2830.34      2658.30      2600.96      2609.15      2576.38         6.17
99.99:        3969.02      2895.87      2789.38      2781.18      2764.80        22.50
worst:        5185.54      4235.26      4333.57      4157.44      4173.82        14.15
```

.25kmsg/s
```
------------------------------- SUMMARY (end to end) ------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:          287.23       285.18       289.28       289.28       287.23         0.95
90.0:          359.94       355.84       370.18       356.86       359.94         2.62
99.0:         4284.42      6103.04      6873.09      3649.54      6856.70        37.06
99.7:         7970.82     12402.69     11681.79      7004.16     12632.06        34.88
99.9:        11714.56     17137.66     14467.07     10698.75     16171.01        28.63
99.97:       14729.22     19365.89     17334.27     14073.86     18382.85        20.04
99.99:       16400.38     20086.78     19365.89     15613.95     19759.10        16.04
99.997:      17072.13     20480.00     20217.86     16695.30     20348.93        13.13
worst:       17596.42     20742.14     20938.75     17465.34     20676.61        11.71
-------------------------------- SUMMARY (publish) --------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:            3.58         3.53         3.61         3.63         3.71         3.22
90.0:            3.93         3.83         5.93         6.06         6.17        28.95
99.0:            6.26         6.18         6.38         6.50         6.54         3.66
99.7:            6.71         6.38         6.57         6.73         6.79         4.17
99.9:            7.83         6.57         6.90         7.22         7.98        12.50
99.97:           9.97         7.61         8.53         8.72         9.04        17.14
99.99:         471.55       177.41       176.38       173.82       301.57        53.31
99.997:       3035.14       449.02       456.19       434.69       547.84        79.95
worst:        5513.22       961.54       869.38       984.06      1185.79        78.08
-------------------------------- SUMMARY (toService) ------------------------------------------
Percentile   run1         run2         run3         run4         run5      % Variation
50.0:          140.03       140.54       141.06       141.57       141.57         0.73
90.0:          185.09       186.11       190.72       185.09       186.62         1.99
99.0:         2379.78      4235.26      3985.41      2445.31      4108.29        34.20
99.7:         4907.01      8216.58      7315.46      4644.86      8003.58        33.89
99.9:         8437.76     10141.70      9682.94      7233.54      9846.78        21.14
99.97:       10240.00     10633.22     10633.22      9453.57     10403.84         7.68
99.99:       11321.34     10895.36     11091.97     10174.46     10600.45         6.99
99.997:      12173.31     11321.34     11288.58     10338.30     11157.50        10.58
worst:       15876.10     12042.24     11616.26     10764.29     11616.26        24.05
```
